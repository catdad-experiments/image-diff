<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Diff</title>
  
  <style>
    canvas {
      padding: 10px;
      max-width: 80vw;
      max-height: 80vh;
    }
  </style>
</head>
<body>
  <div>
    <input id="original" type="file">
    <input id="candidate" type="file">
  </div>
  <div>
    <canvas></canvas>
  </div>
  <script>
    const original = document.querySelector('#original');
    const candidate = document.querySelector('#candidate');
    const canvas = document.querySelector('canvas');
    
    const files = new Map();
    
    const loadUrl = (img, url) => {
      return new Promise((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = e => reject(e);
        img.src = url;
      });
    };
    
    const getBlob = (canvas) => {
      return new Promise((resolve, reject) => {
        try {
          canvas.toBlob(blob => resolve(blob), 'image/png');
        } catch (e) {
          reject(e);
        }
      });
    };
    
    const getImageData = async file => {
      const img = new Image();
      
      const url = URL.createObjectURL(file);
      await loadUrl(img, url);
      URL.revokeObjectURL(url);
      
      const { naturalWidth, naturalHeight } = img;

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = naturalWidth;
      canvas.height = naturalHeight;
      ctx.drawImage(img, 0, 0);
      
      return ctx.getImageData(0, 0, naturalWidth, naturalHeight);
    };
    
    const computeDiff = async (from, to) => {
      console.log('computing diff');
      console.log(from);
      return from;
    };
    
    const loadFile = which => async (ev) => {
      if (!ev.target.files[0]) {
        return;
      }

      const imageData = await getImageData(ev.target.files[0]);
      files.set(which, imageData);
      console.log(which, 'saved');
      
      if (files.has('original') && files.has('candidate')) {
        const diffData = await computeDiff(files.get('original'), files.get('candidate'));
        
        canvas.width = diffData.width;
        canvas.height = diffData.height;
        const ctx = canvas.getContext('2d');

        ctx.putImageData(diffData, 0, 0);
      }
    };
    
    original.addEventListener('change', loadFile('original'));
    candidate.addEventListener('change', loadFile('candidate'));
  </script>
</body>
</html>